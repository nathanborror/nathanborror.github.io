<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Save RAM with mobile middleware</title>
  <meta name="keywords" content="nathan borror, san francisco, ios, swift, django, objective-c, palo alto, design, product design, interaction, engineer, technology">
  <meta name="viewport" content="initial-scale=1, maximum-scale=1">
  <link rel="stylesheet" href="/stylesheets/screen.css">
</head>
<body class="inner">

<header>   <h1><a href="/">Nathan Borror</a></h1> </header>

<article>
# Save RAM with mobile middleware

A while back I wrote an article on how to [set up a mobile site with Django](/posts/2008/feb/18/going-mobile/). Currently I have a [Slicehost](http://www.slicehost.com) account which includes 256MB of RAM. My resources are tight and I really dislike having another set of unnecessary Apache processes for a mobile site that, aside from different templates, is using the same code base. The solution is quite simple, write a middleware.

The following code checks the incoming request for 'm' or 'mobile' in the domain name. If it exists the <code>TEMPLATE_DIRS</code> is replaced by a <code>MOBILE_TEMPLATE_DIRS</code> setting:

```python
class MobileMiddleware(object):
  def process_request(self, request):
    domain = request.META.get('HTTP_HOST', '').split('.')

    if 'm' in domain or 'mobile' in domain:
      settings.TEMPLATE_DIRS = settings.MOBILE_TEMPLATE_DIRS
    else:
      settings.TEMPLATE_DIRS = settings.DESKTOP_TEMPLATE_DIRS
```

You'll notice this requires you to also have a <code>DESKTOP_TEMPLATE_DIRS</code> (or whatever you want to call it) so you can switch back to the desktop version.
If you're using any sort of caching you'll want be sure and change <code>CACHE_MIDDLEWARE_KEY_PREFIX</code> when you change to mobile templates and back again.
You'll probably want to place this middleware after Session and Authentication Middleware and before the Cache Middleware like so:

```python
MIDDLEWARE_CLASSES = (
  'django.contrib.sessions.middleware.SessionMiddleware',
  'django.contrib.auth.middleware.AuthenticationMiddleware',
  'playgroundblues.middleware.MobileMiddleware',
  'django.middleware.cache.UpdateCacheMiddleware',
  'django.middleware.common.CommonMiddleware',
  'django.middleware.cache.FetchFromCacheMiddleware',
)
```

Go Green! Save RAM! (kidding)

<footer><p>October 7, 2008 around 6pm</p></footer>
</article>

</body>
</html>
